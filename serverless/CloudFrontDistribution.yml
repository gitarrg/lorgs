
Type: "AWS::CloudFront::Distribution"

Properties:

  DistributionConfig:
    Enabled: true
    PriceClass: PriceClass_100
    DefaultRootObject: index.html
    Aliases:
      - aws.lorrgs.io
    ViewerCertificate:
      SslSupportMethod: sni-only
      AcmCertificateArn: arn:aws:acm:us-east-1:746912274922:certificate/6d4c8fe1-c717-4e3d-9061-18cc96bd4f4e
      # Add redirects to the index
      # (disabled for debugging. we want to see the 404's from the API)
      # CustomErrorResponses:
      #   - ErrorCode: 403  # Forbidden
      #     ResponsePagePath: /index.html
      #     ResponseCode: 200
      #   - ErrorCode: 404  # Not Found
      #     ResponsePagePath: /index.html
      #     ResponseCode: 200

    #########################
    # Behaviours
    DefaultCacheBehavior:
      AllowedMethods: [GET, OPTIONS, HEAD]
      TargetOriginId: frontend_s3_origin
      CachePolicyId: !Ref S3CachePolicy
      ViewerProtocolPolicy: redirect-to-https
    CacheBehaviors:
      - PathPattern: "api/*"
        TargetOriginId: lambda_origin
        CachePolicyId: !Ref ApiOriginCachePolicy
        ViewerProtocolPolicy: redirect-to-https

    #########################
    # Origins
    Origins:

      # 1) S3 Origin
      - Id: frontend_s3_origin
        DomainName: lorrgs-frontend-dev.s3.eu-west-1.amazonaws.com  # TODO: use `CF`-Expression
        CustomOriginConfig:
          OriginProtocolPolicy: https-only

      # 2) Lambda Origin
      - Id: lambda_origin
        DomainName: !Select [2, !Split [ "/", !GetAtt MainLambdaFunctionUrl.FunctionUrl ]]
        CustomOriginConfig:
          OriginProtocolPolicy: https-only
