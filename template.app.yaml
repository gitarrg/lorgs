# Config for Google App Engine


# >>> gcloud app deploy --project lorrgs -q
# >>> gcloud app deploy --project lorrgs -q --no-promote

service: default
runtime: python39

default_expiration: "7d"  # static files cache

automatic_scaling:
  max_instances: 16


entrypoint: >
  gunicorn
  -b :$PORT
  --timeout=600
  --workers 2
  "lorgs.app:create_app()"
# longer timeout for the api calls that load data


env_variables:

  # Lorgs Config
  LORGS_CONFIG_NAME: lorgs.config.ProductionConfig
  SECRET_KEY: {{SECRET_KEY}}

  # Third Party Credentials
  WCL_CLIENT_ID: {{WARCRAFTLOGS_CLIENT_ID}}
  WCL_CLIENT_SECRET: {{WCL_SECRET}}

  # Database Credentials
  MONGO_URI: {{MONGO_URI}}


handlers:

  # all API-Requests go to the flask backend
  - url: /api/.*
    script: auto

  # server all files in /static as they are
  - url: /static
    static_dir: lorgs/static
    http_headers:
      lorrgs_route: static_files

  # fix to avoid breaking the robots.txt
  - url: /(robots\.txt)
    static_files: static/\1
    mime_type: text/plain
    upload: static/(robots\.txt)

  # all other requests redirect to the index.html
  - url: /(.*)
    static_files: lorgs/static/_generated/index.html
    upload: lorgs/static/_generated/index.html
    expiration: 10m # don't cache the html, as it would cache the old chunk-id's
    http_headers:
      lorrgs_route: app
